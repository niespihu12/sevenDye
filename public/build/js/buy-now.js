function generateUniqueIdempotencyKey(){return`${Date.now()}_${Math.random().toString(36).substring(2,15)}`}document.addEventListener("DOMContentLoaded",(async function(){if(!window.Square)throw new Error("Square.js no se carg√≥ correctamente");const e=window.Square.payments(appId,locationId);try{const t=await e.card();await t.attach("#card-container");const n=document.getElementById("card-button"),a=document.getElementById("payment-status-container");n.addEventListener("click",(async function(){const e=document.getElementById("billing-form");if(e.checkValidity())try{n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Processing...';const e=await t.tokenize();if("OK"===e.status){const t={nombre:document.getElementById("nombre").value,apellido:document.getElementById("apellido").value,compania:document.getElementById("company").value,direccion:document.getElementById("direccion").value,apartamento:document.getElementById("apartamento").value,ciudad:document.getElementById("ciudad").value,postal:document.getElementById("postal").value,telefono:document.getElementById("telefono").value,email:document.getElementById("email").value,terminos:document.getElementById("termsandcondition").checked},i=generateUniqueIdempotencyKey(),o=await fetch("/process-payment-product",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({sourceId:e.token,idempotencyKey:i,productoId:productoId,cantidad:cantidad,tallaId:tallaId,billingDetails:t})}),c=await o.json();c.success?(a.innerHTML='<div class="payment-success"><i class="fas fa-check-circle"></i><p>Payment completed successfully!</p></div>',setTimeout((function(){window.location.href="/confirmar-pago?orden="+c.orden_id}),2e3)):(n.disabled=!1,n.textContent="Pay "+paymentAmount,a.innerHTML='<div class="payment-error"><i class="fas fa-times-circle"></i><p>Payment failed: '+(c.message||"Unknown error")+"</p></div>")}else n.disabled=!1,n.textContent="Pay "+paymentAmount,a.innerHTML='<div class="payment-error"><i class="fas fa-times-circle"></i><p>Card tokenization failed: '+e.errors[0].message+"</p></div>"}catch(e){n.disabled=!1,n.textContent="Pay "+paymentAmount,a.innerHTML='<div class="payment-error"><i class="fas fa-times-circle"></i><p>Payment error: '+e.message+"</p></div>"}else e.reportValidity()}))}catch(e){document.getElementById("payment-status-container").innerHTML='<div class="payment-error"><i class="fas fa-times-circle"></i><p>Error loading payment form: '+e.message+"</p></div>"}}));