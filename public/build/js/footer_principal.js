function updateCartCounter(){fetch("/cart/count",{method:"GET",headers:{Accept:"application/json"}}).then((t=>t.json())).then((t=>{if(t.count){updateCounter(document.querySelector(".navegacion-secundaria .carrito"),t.count);updateCounter(document.querySelector(".barra-mobile .carrito"),t.count)}})).catch((t=>console.error("Error fetching cart count:",t)))}function updateWishlistCounter(){fetch("/wishlist/count",{method:"GET",headers:{Accept:"application/json"}}).then((t=>t.json())).then((t=>{if(t.count){updateCounter(document.querySelector(".navegacion-secundaria .favoritos"),t.count);updateCounter(document.querySelector(".barra-mobile .like"),t.count)}})).catch((t=>console.error("Error fetching wishlist count:",t)))}function updateCounter(t,e){if(!t)return;let n=t.querySelector(".counter-badge");e>0?(n||(n=document.createElement("span"),n.className="counter-badge",t.appendChild(n)),n.textContent=e,n.style.display="flex"):n&&(n.style.display="none")}function toggleWishlist(t){fetch(`/wishlist/verify?producto=${t}`,{method:"GET",headers:{Accept:"application/json"}}).then((t=>t.json())).then((e=>{const n=e.enLista;fetch("/wishlist/"+(n?"delete":"save"),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({producto:t})}).then((t=>t.json())).then((e=>{e.resultado&&(document.dispatchEvent(new CustomEvent("wishlistUpdated")),toggleWishlistButtonState(t,!n),showNotification(e.mensaje))})).catch((t=>console.error("Error toggling wishlist:",t)))})).catch((t=>console.error("Error checking wishlist status:",t)))}function toggleWishlistButtonState(t,e){document.querySelectorAll(`.wishlist-btn[data-id="${t}"]`).forEach((t=>{e?(t.classList.add("active"),t.querySelector("i")&&(t.querySelector("i").classList.remove("bi-heart"),t.querySelector("i").classList.add("bi-heart-fill"))):(t.classList.remove("active"),t.querySelector("i")&&(t.querySelector("i").classList.remove("bi-heart-fill"),t.querySelector("i").classList.add("bi-heart")))}))}function showNotification(t){let e=document.getElementById("notification-container");e||(e=document.createElement("div"),e.id="notification-container",document.body.appendChild(e));const n=document.createElement("div");n.className="notification",n.textContent=t,e.appendChild(n),setTimeout((()=>{n.classList.add("fade-out"),setTimeout((()=>{n.remove()}),500)}),3e3)}function addToCart(t,e=1,n=null){const o=new FormData;o.append("id",t),o.append("cantidad",e);const i=generateToken(t);o.append("token",i),n&&o.append("talla",n),fetch("/cart/add",{method:"POST",body:o}).then((t=>t.json())).then((t=>{t.ok?(document.dispatchEvent(new CustomEvent("cartUpdated")),showNotification("Product added to cart")):showNotification("Error adding product to cart")})).catch((t=>console.error("Error adding to cart:",t)))}function generateToken(t){return"token_"+t}document.addEventListener("DOMContentLoaded",(function(){updateCartCounter(),updateWishlistCounter(),document.addEventListener("click",(function(t){const e=t.target.closest(".wishlist-btn");if(e){const t=e.dataset.id;t&&toggleWishlist(t)}})),document.addEventListener("cartUpdated",(function(){updateCartCounter()})),document.addEventListener("wishlistUpdated",(function(){updateWishlistCounter()}));function t(t,n){const o=document.getElementById(t),i=document.getElementById(n);o&&i&&(o.addEventListener("input",function(t,e){let n;return function(...o){const i=this;clearTimeout(n),n=setTimeout((()=>t.apply(i,o)),e)}}((function(t){const n=t.target.value.trim();n.length>=2?e(n,i):(i.innerHTML="",i.classList.remove("show"))}),300)),document.addEventListener("click",(function(t){o.contains(t.target)||i.contains(t.target)||i.classList.remove("show")})),o.addEventListener("focus",(function(){this.value.trim().length>=2&&e(this.value.trim(),i)})))}function e(t,e){e.innerHTML='<div class="loading">Buscando...</div>',e.classList.add("show"),fetch(`/products/search?q=${encodeURIComponent(t)}`).then((t=>t.json())).then((t=>{t.length>0?async function(t,e){e.innerHTML="";const o=document.createDocumentFragment();(await Promise.all(t.map((async t=>({...t,link:await n(t.slug)}))))).forEach((t=>{const e=document.createElement("a");e.href=t.link,e.className="search-item";const n=t.imagen?`<div class="search-item-image">\n    <img src="/imagenes/${t.imagen}" alt="${t.nombre}">\n</div>`:"";e.innerHTML=`\n${n}\n<div class="search-item-info">\n    <div class="search-item-name">${t.nombre}</div>\n    <div class="search-item-price">$${t.precio}</div>\n</div>\n`,o.appendChild(e)})),e.appendChild(o)}(t,e):e.innerHTML='<div class="no-results">No se encontraron productos</div>'})).catch((t=>{console.error("Error en la b√∫squeda:",t),e.innerHTML='<div class="error">Error al buscar productos</div>'}))}async function n(t){try{const e=new TextEncoder,n=await crypto.subtle.importKey("raw",e.encode("APR.wqc-354*"),{name:"HMAC",hash:"SHA-1"},!1,["sign"]),o=await crypto.subtle.sign("HMAC",n,e.encode(t)),i=Array.from(new Uint8Array(o)).map((t=>t.toString(16).padStart(2,"0"))).join("");return`/details/${encodeURIComponent(t)}?token=${i}`}catch(t){return console.error("Error generando enlace:",t),"#"}}t("search-input-desktop","search-results-desktop"),t("search-input-mobile","search-results-mobile")}));