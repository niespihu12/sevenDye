let appId,locationId,card;function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}function validateForm(e){let t=!0;return e.querySelectorAll("[required]").forEach((e=>{e.value.trim()?e.classList.remove("error"):(e.classList.add("error"),t=!1)})),t}function showMessage(e,t="info"){const o=document.getElementById("payment-status-container");o.innerHTML=`<div class="payment-status ${t}">${e}</div>`,o.scrollIntoView({behavior:"smooth"})}function initCheckout(e,t){appId=e,locationId=t}document.addEventListener("DOMContentLoaded",(async function(){if(!window.Square)return console.error("Square.js failed to load properly"),void showMessage("Payment system is currently unavailable. Please try again later.","error");try{const e=window.Square.payments(appId,locationId);card=await e.card(),await card.attach("#card-container")}catch(e){return console.error("Initializing Card failed",e),void showMessage("Payment system initialization failed. Please try again later.","error")}const e=document.getElementById("apply-coupon");e&&e.addEventListener("click",(async()=>{const e=document.getElementById("cupon-code").value.trim(),t=document.getElementById("coupon-message");if(t.textContent="",t.classList.remove("error","success"),!e)return t.textContent="Please enter a coupon code",void t.classList.add("error");try{const o=await fetch("/cart/apply-coupon",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({codigo:e})}),n=await o.json();n.ok?(t.textContent=n.mensaje,t.classList.add("success"),window.location.reload()):(t.textContent=n.mensaje,t.classList.add("error"))}catch(e){console.error("Error:",e),t.textContent="Error applying coupon",t.classList.add("error")}}));const t=document.getElementById("remove-coupon");t&&t.addEventListener("click",(async()=>{try{const e=await fetch("/cart/remove-coupon",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});(await e.json()).ok&&window.location.reload()}catch(e){console.error("Error:",e)}}));const o=document.getElementById("place-order-btn");o.addEventListener("click",(async function(e){e.preventDefault();if(validateForm(document.getElementById("billing-form")))try{o.disabled=!0,o.textContent="Processing...";const e=await card.tokenize();if("OK"===e.status){console.log("Payment token generated:",e.token);const t=document.getElementById("cupon-code"),n=t?t.value.trim():"",r=crypto.randomUUID?crypto.randomUUID():generateUUID(),a=document.getElementById("total-amount").textContent.replace(/[^\d.-]/g,"");console.log(a);const s=parseFloat(a),c=(Math.round(100*s),await fetch("/process-payment",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({sourceId:e.token,idempotencyKey:r,cuponCodigo:n})})),i=await c.json();if(i.success)window.location.href=`/confirmacion-pago?orden=${i.orden_id}`;else{let e=i.message||"Payment failed. Please try again.";i.errors&&console.error("Square Payment Error:",i.errors),showMessage(e,"error"),o.disabled=!1,o.textContent="Complete Order"}}else{showMessage(e.errors?.[0]?.message||"Card validation failed","error"),o.disabled=!1,o.textContent="Complete Order"}}catch(e){console.error("Payment Error:",e),showMessage("Payment processing error. Please try again.","error"),o.disabled=!1,o.textContent="Complete Order"}else showMessage("Please fill all required fields","error")}))}));