<section class="signup">

    <div class="signup__imagen-izquierda">
        <picture>
            <source srcset="/build/img/derecha.avif" type="image/avif">
            <source srcset="/build/img/derecha.webp" type="image/webp">
            <img loading="lazy" width="100" height="100" src="/build/img/derecha.jpg"
                alt="Modelo con camiseta tie-dye amarilla">
        </picture>
    </div>


    <div class="signup__contenido">
        <h2>SIGN UP TO GET LATEST UPDATES</h2>
        <p>Seven Dye is an online fashion retailer based in Miami, Florida, offering a wide range of high-quality
            tie-dye
            and colorful clothing. Seven Dye provides gender-less clothing for all styles and sizes, empowering customers
            across the United States with vibrant and authentic fashion. Dress your life in color!</p>

        <form class="signup__form">
            <input type="email" placeholder="Your Email Address...">
            <button type="submit">Subscribe</button>
        </form>

        <div class="signup__social">
            <div class="signup__social--redes">
                <a href="#" class="redes">
                    <picture>
                        <source srcset="/build/img/instagram.avif" type="image/avif">
                        <source srcset="/build/img/instagram.webp" type="image/webp">
                        <img loading="lazy" width="100" height="100" src="/build/img/instagram.jpg" alt="Instagram">
                    </picture>

                    <p>Instagram</p>
                </a>
            </div>
            <div class="signup__social--redes">
                <a href="#" class="redes">
                    <picture>
                        <source srcset="/build/img/tik-tok.avif" type="image/avif">
                        <source srcset="/build/img/tik-tok.webp" type="image/webp">
                        <img loading="lazy" width="100" height="100" src="/build/img/tik-tok.jpg" alt="Tiktok">
                    </picture>
                    <p>Tiktok</p>

                </a>
            </div>
            <div class="signup__social--redes">
                <a href="#" class="redes">
                    <picture>
                        <source srcset="/build/img/facebook.avif" type="image/avif">
                        <source srcset="/build/img/facebook.webp" type="image/webp">
                        <img loading="lazy" width="100" height="100" src="/build/img/facebook.jpg" alt="facebook">
                    </picture>
                    <p>Facebook</p>
                </a>
            </div>
            <div class="signup__social--redes">
                <a href="#" class="redes">
                    <picture>
                        <source srcset="/build/img/youtube.avif" type="image/avif">
                        <source srcset="/build/img/youtube.webp" type="image/webp">
                        <img loading="lazy" width="100" height="100" src="/build/img/youtube.jpg" alt="youtube">
                    </picture>
                    <p>Youtube</p>
                </a>

            </div>
        </div>
    </div>

    <div class="signup__imagen-derecha">
        <picture>
            <source srcset="/build/img/izquierda.avif" type="image/avif">
            <source srcset="/build/img/izquierda.webp" type="image/webp">
            <img loading="lazy" width="100" height="100" src="/build/img/izquierda.jpg"
                alt="Modelo con camiseta tie-dye rosa">
        </picture>
    </div>
</section>



<footer class="footer">
    <div class="footer__servicios contenedor">
        <div class="servicio">
            <div class="servicio__imagen">
                <picture>
                    <source srcset="/build/img/calidad-del-producto.avif" type="image/avif">
                    <source srcset="/build/img/calidad-del-producto.webp" type="image/webp">
                    <img loading="lazy" width="100" height="100" src="/build/img/calidad-del-producto.png" alt="">
                </picture>
            </div>
            <p>Free Delivery<span>From $199.00</span></p>
        </div>
        <div class="servicio">
            <div class="servicio__imagen">
                <picture>
                    <source srcset="/build/img/servicio-al-cliente.avif" type="image/avif">
                    <source srcset="/build/img/servicio-al-cliente.webp" type="image/webp">
                    <img loading="lazy" width="100" height="100" src="/build/img/servicio-al-cliente.png" alt="">
                </picture>
            </div>
            <p>Support 24/7<span>Online 24 Hours</span></p>
        </div>
        <div class="servicio">
            <div class="servicio__imagen">
                <picture>
                    <source srcset="/build/img/calidad-del-producto.avif" type="image/avif">
                    <source srcset="/build/img/calidad-del-producto.webp" type="image/webp">
                    <img loading="lazy" width="100" height="100" src="/build/img/calidad-del-producto.png" alt="">
                </picture>
            </div>
            <p>Top Quality<span>manufacturing</span></p>
        </div>
        <div class="servicio">
            <div class="servicio__imagen">
                <picture>
                    <source srcset="/build/img/metodo-de-pago.avif" type="image/avif">
                    <source srcset="/build/img/metodo-de-pago.webp" type="image/webp">
                    <img loading="lazy" width="100" height="100" src="/build/img/metodo-de-pago.png" alt="">
                </picture>
            </div>
            <p>Payment Method<span>Secure Payment</span></p>
        </div>
        <div class="servicio">
            <div class="servicio__imagen">
                <picture>
                    <source srcset="/build/img/abrazo-con-cliente.avif" type="image/avif">
                    <source srcset="/build/img/abrazo-con-cliente.webp" type="image/webp">
                    <img loading="lazy" width="100" height="100" src="/build/img/abrazo-con-cliente.png" alt="">
                </picture>
            </div>
            <p>Inclusivity<span>All sizes XXS to 5XL</span></p>
        </div>
    </div>

    <nav class="footer__nav contenedor">
        <a href="#">Support Center</a>
        <a href="#">Invoicing</a>
        <a href="#">Contract</a>
        <a href="#">Frequently Asked Questions</a>
        <a href="#">Blog</a>
        <a href="#">Terms and Conditions</a>
    </nav>

    <div class="footer__bottom contenedor">
        <div class="footer__logo">
            <picture>
                <source srcset="/build/img/logo_de_seven.avif" type="image/avif">
                <source srcset="/build/img/logo_de_seven.webp" type="image/webp">
                <img loading="lazy" width="100" height="100" src="/build/img/logo_de_seven.jpg" alt="Logo de SevenDye">
            </picture>
        </div>

        <p>Copyright © 2024 Seven Dye</p>
        <div class="footer__pagos">
            <picture>
                <source srcset="/build/img/payments.avif" type="image/avif">
                <source srcset="/build/img/payments.webp" type="image/webp">
                <img loading="lazy" width="100" height="100" src="/build/img/payments.jpg" alt="metodos">
            </picture>
        </div>
    </div>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        // Initialize counters
        updateCartCounter();
        updateWishlistCounter();

        // Add event listeners for wishlist buttons
        document.addEventListener('click', function(e) {
            const wishlistBtn = e.target.closest('.wishlist-btn');
            if (wishlistBtn) {
                const productId = wishlistBtn.dataset.id;
                if (productId) {
                    toggleWishlist(productId);
                }
            }
        });

        // Listen for custom events from cart operations
        document.addEventListener('cartUpdated', function() {
            updateCartCounter();
        });

        document.addEventListener('wishlistUpdated', function() {
            updateWishlistCounter();
        });
        const KEY_TOKEN = "APR.wqc-354*";

        // Inicializar búsqueda para desktop
        initializeSearch('search-input-desktop', 'search-results-desktop');

        // Inicializar búsqueda para mobile
        initializeSearch('search-input-mobile', 'search-results-mobile');

        function initializeSearch(inputId, resultsId) {
            const searchInput = document.getElementById(inputId);
            const searchResults = document.getElementById(resultsId);

            if (searchInput && searchResults) {
                searchInput.addEventListener('input', debounce(function(e) {
                    const searchTerm = e.target.value.trim();

                    if (searchTerm.length >= 2) {
                        fetchSearchResults(searchTerm, searchResults);
                    } else {
                        searchResults.innerHTML = '';
                        searchResults.classList.remove('show');
                    }
                }, 300));

                document.addEventListener('click', function(event) {
                    if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
                        searchResults.classList.remove('show');
                    }
                });

                searchInput.addEventListener('focus', function() {
                    if (this.value.trim().length >= 2) {
                        fetchSearchResults(this.value.trim(), searchResults);
                    }
                });
            }
        }

        function fetchSearchResults(query, resultsContainer) {
            resultsContainer.innerHTML = '<div class="loading">Buscando...</div>';
            resultsContainer.classList.add('show');

            fetch(`/productos/buscar?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        renderSearchResults(data, resultsContainer);
                    } else {
                        resultsContainer.innerHTML = '<div class="no-results">No se encontraron productos</div>';
                    }
                })
                .catch(error => {
                    console.error('Error en la búsqueda:', error);
                    resultsContainer.innerHTML = '<div class="error">Error al buscar productos</div>';
                });
        }

        async function renderSearchResults(results, resultsContainer) {
            resultsContainer.innerHTML = '';
            const resultsFragment = document.createDocumentFragment();

            const productsWithLinks = await Promise.all(results.map(async product => {
                return {
                    ...product,
                    link: await generateSecureLink(product.slug)
                };
            }));

            productsWithLinks.forEach(product => {
                const item = document.createElement('a');
                item.href = product.link;
                item.className = 'search-item';

                const imageHtml = product.imagen ?
                    `<div class="search-item-image">
        <img src="/imagenes/${product.imagen}" alt="${product.nombre}">
    </div>` : '';

                item.innerHTML = `
    ${imageHtml}
    <div class="search-item-info">
        <div class="search-item-name">${product.nombre}</div>
        <div class="search-item-price">$${product.precio}</div>
    </div>
`;

                resultsFragment.appendChild(item);
            });

            resultsContainer.appendChild(resultsFragment);
        }

        async function generateSecureLink(slug) {
            try {
                const encoder = new TextEncoder();
                const key = await crypto.subtle.importKey(
                    "raw",
                    encoder.encode(KEY_TOKEN), {
                        name: "HMAC",
                        hash: "SHA-1"
                    },
                    false,
                    ["sign"]
                );
                const signature = await crypto.subtle.sign(
                    "HMAC",
                    key,
                    encoder.encode(slug)
                );
                const hexSignature = Array.from(new Uint8Array(signature))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');

                return `/detalles/${encodeURIComponent(slug)}?token=${hexSignature}`;

            } catch (error) {
                console.error('Error generando enlace:', error);
                return '#';
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
    });

    function updateCartCounter() {
        fetch('/carrito/count', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.count) {
                    // Update desktop counter
                    const desktopCartIcon = document.querySelector('.navegacion-secundaria .carrito');
                    updateCounter(desktopCartIcon, data.count);

                    // Update mobile counter
                    const mobileCartIcon = document.querySelector('.barra-mobile .carrito');
                    updateCounter(mobileCartIcon, data.count);
                }
            })
            .catch(error => console.error('Error fetching cart count:', error));
    }

    /**
     * Updates the wishlist counter in both mobile and desktop views
     */
    function updateWishlistCounter() {
        fetch('/deseos/count', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.count) {
                    // Update desktop counter
                    const desktopWishlistIcon = document.querySelector('.navegacion-secundaria .favoritos');
                    updateCounter(desktopWishlistIcon, data.count);

                    // Update mobile counter
                    const mobileWishlistIcon = document.querySelector('.barra-mobile .like');
                    updateCounter(mobileWishlistIcon, data.count);
                }
            })
            .catch(error => console.error('Error fetching wishlist count:', error));
    }

    /**
     * Adds or updates a counter badge on an element
     * @param {HTMLElement} element - The element to add the counter to
     * @param {number} count - The count to display
     */
    function updateCounter(element, count) {
        if (!element) return;

        let counter = element.querySelector('.counter-badge');

        if (count > 0) {
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'counter-badge';
                element.appendChild(counter);
            }
            counter.textContent = count;
            counter.style.display = 'flex';
        } else if (counter) {
            counter.style.display = 'none';
        }
    }

    /**
     * Toggles a product in the wishlist
     * @param {number} productId - The ID of the product to toggle
     */
    function toggleWishlist(productId) {
        fetch(`/deseos/verificar?producto=${productId}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const isInWishlist = data.enLista;
                const url = '/deseos/' + (isInWishlist ? 'eliminar' : 'guardar');

                fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            producto: productId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.resultado) {
                            document.dispatchEvent(new CustomEvent('wishlistUpdated'));
                            toggleWishlistButtonState(productId, !isInWishlist);
                            showNotification(data.mensaje);
                        }
                    })
                    .catch(error => console.error('Error toggling wishlist:', error));
            })
            .catch(error => console.error('Error checking wishlist status:', error));
    }

    /**
     * Updates the visual state of wishlist buttons for a specific product
     * @param {number} productId - The ID of the product
     * @param {boolean} isInWishlist - Whether the product is in the wishlist
     */
    function toggleWishlistButtonState(productId, isInWishlist) {
        const wishlistButtons = document.querySelectorAll(`.wishlist-btn[data-id="${productId}"]`);

        wishlistButtons.forEach(btn => {
            if (isInWishlist) {
                btn.classList.add('active');
                if (btn.querySelector('i')) {
                    btn.querySelector('i').classList.remove('bi-heart');
                    btn.querySelector('i').classList.add('bi-heart-fill');
                }
            } else {
                btn.classList.remove('active');
                if (btn.querySelector('i')) {
                    btn.querySelector('i').classList.remove('bi-heart-fill');
                    btn.querySelector('i').classList.add('bi-heart');
                }
            }
        });
    }

    /**
     * Shows a notification message
     * @param {string} message - The message to display
     */
    function showNotification(message) {
        let notificationContainer = document.getElementById('notification-container');
        if (!notificationContainer) {
            notificationContainer = document.createElement('div');
            notificationContainer.id = 'notification-container';
            document.body.appendChild(notificationContainer);
        }

        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;

        notificationContainer.appendChild(notification);

        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => {
                notification.remove();
            }, 500);
        }, 3000);
    }

    /**
     * Function to add a product to cart
     * Can be called from product pages
     */
    function addToCart(productId, cantidad = 1, talla = null) {
        const formData = new FormData();
        formData.append('id', productId);
        formData.append('cantidad', cantidad);

        const token = generateToken(productId);
        formData.append('token', token);

        if (talla) {
            formData.append('talla', talla);
        }

        fetch('/carrito/agregar', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    document.dispatchEvent(new CustomEvent('cartUpdated'));
                    showNotification('Product added to cart');
                } else {
                    showNotification('Error adding product to cart');
                }
            })
            .catch(error => console.error('Error adding to cart:', error));
    }

    /**
     * Simple token generator to match PHP hash_hmac implementation
     */
    function generateToken(id) {
        return 'token_' + id;
    }
</script>